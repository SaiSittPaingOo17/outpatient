{% extends 'patient/layout.html' %}
{% block body %}

<div class="d-flex justify-content-center align-items-center" style="min-height: 90vh;">
    <div class="card shadow-lg p-4 mb-5 border-dark" style="width: 100%; max-width: 900px; border-radius: 15px;">

        <h2 class="text-center mb-4" style="font-weight: 600;">Patient Registration</h2>

        <form method="POST" id="patient_register" action="{% url 'patient:patient_register' %}">
            {% csrf_token %}

            <!-- Row 1: Title / First Name / Last Name -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Title</label>
                    <select name="title" id="title" class="form-select border-dark">
                        <option value="mr">Mr</option>
                        <option value="mrs">Mrs</option>
                        <option value="mss">Miss</option>
                        <option value="ms">Ms</option>
                        <option value="dr">Dr</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold">First Name</label>
                    <input type="text" name="fname" class="form-control border-dark" placeholder="Enter first name" value="{{fname}}">
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-semibold">Last Name</label>
                    <input type="text" name="lname" class="form-control border-dark" placeholder="Enter last name" value="{{lname}}">
                </div>
            </div>

            <!-- Row 2: DOB / Gender / Marital -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Date of Birth</label>
                    <input type="date" name="date_of_birth" class="form-control border-dark"
                           value="{{date_of_birth|date:'Y-m-d'}}">
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold ">Gender</label>
                    <div class="border border-dark rounded p-2">
                        <div class="form-check">
                            <input type="radio" class="form-check-input border-dark" name="gender" value="M"
                                   {% if gender == 'M' %}checked{% endif %}>
                            <label class="form-check-label">Male</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input border-dark" name="gender" value="F"
                                   {% if gender == 'F' %}checked{% endif %}>
                            <label class="form-check-label">Female</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input border-dark" name="gender" value="O"
                                   {% if gender == 'O' %}checked{% endif %}>
                            <label class="form-check-label">Other</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input border-dark" name="gender" value="P"
                                   {% if gender == 'P' %}checked{% endif %}>
                            <label class="form-check-label">Prefer not to say</label>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Marital Status</label>
                    <select name="marital_status" id="marital_status" class="form-select border-dark">
                        <option value="U">Unmarried</option>
                        <option value="M">Married</option>
                        <option value="P">Prefer not to say</option>
                    </select>
                </div>
            </div>

            <!-- Row 3: Contact -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Phone Number</label>
                    <input type="text" name="phone" class="form-control border-dark" placeholder="Enter phone number" value="{{phone}}">
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Email</label>
                    <input type="email" name="email" class="form-control border-dark" value="{{email}}">
                </div>
            </div>

            <!-- Address -->
            <div class="mb-4">
                <label class="form-label fw-semibold">Address</label>
                <textarea class="form-control border-dark" name="address" rows="3">{{address}}</textarea>
            </div>

            <!-- Password row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Password</label>
                    <input type="password" name="password" id="passwordInput" class="form-control border-dark">
                    <div id="password-strength" class="mt-1"></div>
                    <small class="text-muted">Must include uppercase, lowercase, number, special character.</small>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Confirm Password</label>
                    <input type="password" id="re-passwordInput" class="form-control border-dark">
                    <div id="password-match" class="mt-1"></div>
                </div>
            </div>

            <!-- Terms -->
            <div class="form-check mb-4">
                <input type="checkbox" class="form-check-input border-dark" id="checkAgree">
                <label class="form-check-label">I agree to the Terms & Conditions</label>
            </div>

            <!-- Submit -->
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit" disabled style="border-radius: 10px;">
                    Register
                </button>
            </div>

            <div class="text-center mt-3">
                <small>
                    Already have an account?
                    <a href="{% url 'patient:patient_login' %}" class="fw-semibold">Login Here</a>
                </small>
            </div>

        </form>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function(){
              
        // Agree Terms and Conditions
        const form = document.querySelector('#patient_register')
        const agree = document.querySelector('#checkAgree');

        form.onsubmit = function(event){
            if(!agree.checked){
                event.preventDefault();
                alert("Please agree Terms and Condtions")
            }
        }
        

        //////////////////////////////////////////////////////
        // Checking Password Strength and Matching

        const passwordInput = document.querySelector('#passwordInput');
        const confirmPassword = document.querySelector('#re-passwordInput');
        const passwordStrength = document.querySelector('#password-strength');
        const passwordMatch = document.querySelector('#password-match');
        const submitButton = document.querySelector('#btnSubmit');
        const registerForm = document.querySelector('form')

        // Checking Password Strength
        function checkPasswordStrength(password){

            let strength = 0;
            let feedback = [];

            // Length 
            if(password.length >= 8){
                strength++;
            }else{
                feedback.push('At least 8 characters')
            }

            // uppercase
            if(/[A-Z]/.test(password)){
                strength++;
            }else{
                feedback.push('One Uppercase')
            }

            // Lowercase
            if(/[a-z]/.test(password)){
                strength++;
            }else{
                feedback.push('One Lowercase');
            }

            // Number
            if(/[\d]/.test(password)){
                strength++;
            }else{
                feedback.push('One number')
            }

            // Special Character
            if(/[^A-Za-z0-9]/.test(password)){
                strength++;
            }else{
                feedback.push('One Special Character')
            }

            return {strength, feedback};

        }

        // Password Strength Display
        function updatePasswordStrength(){

            const pwd = passwordInput.value;
            const result = checkPasswordStrength(pwd);

            if(pwd.length === 0){
                passwordStrength.innerHTML='';
                return false;
            }

            let strengthText = '';
            let strengthClass = '';
            let isStrong = false;

            if(result.strength <= 2){
                strengthClass = 'strength-weak text-danger';
                strengthText = 'Weak';
                isStrong = false;
            }
            else if(result.strength <=4){
                strengthClass = 'strength-medium text-warning'; 
                strengthText = 'Medium';
                isStrong = false;
            }
            else{
                strengthClass = 'strength-strong text-success';
                strengthText = 'Strong';
                isStrong = true;
            }
            passwordStrength.innerHTML = `<div class="${strengthClass}">
                                                Password Strength: ${strengthText}
                                                <small class='text-danger'>${result.feedback.length > 0 ? `<br> ${result.feedback.join(', ')}` : ''}</small>
                                            </div>`;

            return isStrong;
        }

        // Check Password Match
        function checkPasswordMatch(){
            const pwd = passwordInput.value;
            const re_pwd = confirmPassword.value;

            if(re_pwd.length === 0){
                passwordMatch.innerHTML='';
                return false;
            }

            if(pwd === re_pwd){
                passwordMatch.innerHTML= `<div class='pwd_match text-success'>
                                            <small>Passwords match</small>
                                        </div>`;
                return true;
            }
            else{
                passwordMatch.innerHTML= `<div class='pwd_match text-danger'>
                                            <small>Passwords don't match</small>
                                        <div>`;
                return false;
            }
        }
        // Enable/Disable Submit Button
        function updateSubmitButton(){
            const isPasswordStrong = updatePasswordStrength();
            const isPasswordMatch = checkPasswordMatch();

            submitButton.disabled = !(isPasswordStrong && isPasswordMatch);
        }

        // Add Listener
        
        passwordInput.addEventListener('input', function(){
            updatePasswordStrength();
            updateSubmitButton();
        });
        confirmPassword.addEventListener('input', function(){
            checkPasswordMatch();
            updateSubmitButton();
        });
        agree.addEventListener('change', function(){
                updateSubmitButton();
            }); 
        
        registerForm.addEventListener('submit',function(){

            const isPasswordStrong = updatePasswordStrength();
            const isPasswordMatch = checkPasswordMatch();

            if (!isPasswordStrong || !isPasswordMatch) {
                event.preventDefault();
                alert('Please check your password');
                return;
            }
        });
    })

</script>

{% endblock%}
