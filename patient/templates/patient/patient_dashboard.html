{% extends "appointment/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">

    <h2 class="mb-4 fw-bold">Dashboard</h2>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">

        <div class="col-md-3">
            <div class="card border-primary shadow-sm p-3 text-center">
                <h6 class="text-primary">Upcoming Appointments</h6>
                <h2 class="fw-bold text-primary">{{ upcoming_appointments.count }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-success shadow-sm p-3 text-center">
                <h6 class="text-success">Past Appointments</h6>
                <h2 class="fw-bold text-success">{{ past_appointments.count }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-warning shadow-sm p-3 text-center">
                <h6 class="text-warning">Visit Records</h6>
                <h2 class="fw-bold text-warning">{{ visit_records.count }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-danger shadow-sm p-3 text-center">
                <h6 class="text-danger">Payments</h6>
                <h2 class="fw-bold text-danger">{{ payments.count }}</h2>
            </div>
        </div>

    </div>


    <!-- Upcoming Appointments -->
    <h4 class="fw-semibold mb-3 mt-4">Upcoming Appointments</h4>
    <table class="table table-bordered align-middle">
        <thead class="table-primary">
            <tr>
                <th>Date & Time</th>
                <th>Doctor</th>
                <th>Department</th>
                <th>Visit Reason</th>
                <th>Status</th>
            </tr>
        </thead>

        <tbody>
            {% for app in upcoming_appointments %}
            <tr class="table-info">
                <td>{{ app.appointed_datetime|date:"Y-m-d H:i" }}</td>
                <td>Dr. {{ app.doctor }}</td>
                <td>{{ app.doctor.department }}</td>
                <td>{{ app.visit_reason }}</td>
                <td><span class="badge bg-primary">Upcoming</span></td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-muted">No upcoming appointments.</td></tr>
            {% endfor %}
        </tbody>
    </table>



    <hr>


    <!-- Past Appointments -->
    <h4 class="fw-semibold mb-3 mt-4">Past Appointments</h4>
    <table class="table table-bordered align-middle">
        <thead class="table-secondary">
            <tr>
                <th>Date & Time</th>
                <th>Doctor</th>
                <th>Department</th>
                <th>Visit Reason</th>
                <th>Status</th>
            </tr>
        </thead>

        <tbody>
            {% for app in past_appointments %}
            <tr class="table-light"> <!-- Light grey row -->
                <td>{{ app.appointed_datetime|date:"Y-m-d H:i" }}</td>
                <td>Dr. {{ app.doctor.fname }} {{ app.doctor.lname }}</td>
                <td>{{ app.doctor.department }}</td>
                <td>{{ app.visit_reason }}</td>
                <td><span class="badge bg-secondary">Completed</span></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-muted text-center">No past appointments</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <hr>


    <!-- Prescriptions -->
    <h4 class="fw-semibold mb-3">Prescriptions</h4>

    {% for cons in consultations %}
    <div class="card mb-3 shadow-sm">
        <div class="card-body">

            <h5>
                Consultation ID: {{ cons.id }}
            </h5>

            <p class="mb-1">
                <strong>Date:</strong> {{ cons.created_at|date:"Y-m-d H:i" }}<br>
                <strong>Doctor:</strong> Dr. {{ cons.doctor.fname }} {{ cons.doctor.lname }}
            </p>

            <hr>

            {% if cons.prescription_set.all %}
                <table class="table table-sm">
                    <tbody>
                    {% for pres in cons.prescription_set.all %}
                        <tr>
                            <td><strong>{{ pres.prescription }}</strong></td>
                            <td class="text-end">
                                {% if pres.status == "completed" %}
                                    <span class="badge bg-success">Completed</span>
                                {% elif pres.status == "processing" %}
                                    <span class="badge bg-warning text-dark">Processing</span>
                                {% else %}
                                    <span class="badge bg-secondary">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No prescriptions for this consultation.</p>
            {% endif %}

        </div>
    </div>
    {% empty %}
    <p class="text-muted">No consultations found.</p>
    {% endfor %}


    <hr>


    <!-- Payments -->
    <h4 class="fw-semibold mb-2">Payments</h4>
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Invoice ID</th>
                <th>Total (Ks)</th>
                <th>Paid (Ks)</th>
                <th>Status</th>
                <th>Invoice</th>
            </tr>
        </thead>
        <tbody>
            {% for pay in payments %}
            <tr>
                <td>{{ pay.id }}</td>
                <td class="fw-semibold">{{ pay.total_amount }}</td>
                <td>{{ pay.amount_paid }}</td>
                <td>
                    {% if pay.status == "paid" %}
                        <span class="badge bg-success">Paid</span>
                    {% elif pay.status == "partial" %}
                        <span class="badge bg-warning text-dark">Partial</span>
                    {% else %}
                        <span class="badge bg-danger">Unpaid</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'payment:payment_invoice' pay.id %}" class="btn btn-sm btn-primary">
                        View
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-muted">No payment records.</td></tr>
            {% endfor %}
        </tbody>
    </table>

</div>

{% endblock %}
